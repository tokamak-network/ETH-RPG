// 64x64 pixel art sprite definitions for each RPG class
// Source art is 32x32, upscaled to 64x64 via Scale2x algorithm for smoother edges
// Pipeline: source 32x32 → addOutline() → scale2x() → export 64x64
//
// Palette:
//   '.' = transparent
//   '1' = primary midtone (class color, dynamic from theme)
//   '2' = primary highlight (lighter, auto-generated — top/left surfaces)
//   '6' = secondary shadow (darker, dynamic from theme — bottom/right surfaces)
//   '3' = skin (#e8b87e)
//   '4' = skin shadow (#c48c5a)
//   '5' = brown boots (#6b4226)
//   '7' = dark/eyes (#1a1a2e) — eyes ONLY, outlines are auto-generated
//   '8','9','a' = class-specific accents

import type { CharacterClassId } from '@/lib/types';

export interface SpritePalette {
  readonly [key: string]: string;
}

export interface SpriteDefinition {
  readonly grid: readonly string[];
  readonly palette: SpritePalette;
}

// Auto-outline: replaces outermost filled pixels with dark outline '7'
function addOutline(grid: readonly string[]): readonly string[] {
  const h = grid.length;
  const w = grid[0].length;
  const result = grid.map(row => [...row]);

  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      const ch = grid[y][x];
      if (ch !== '.' && ch !== '7') {
        const top = y > 0 ? grid[y - 1][x] : '.';
        const bot = y < h - 1 ? grid[y + 1][x] : '.';
        const lft = x > 0 ? grid[y][x - 1] : '.';
        const rgt = x < w - 1 ? grid[y][x + 1] : '.';
        if (top === '.' || bot === '.' || lft === '.' || rgt === '.') {
          result[y][x] = '7';
        }
      }
    }
  }

  return result.map(row => row.join(''));
}

// Scale2x pixel art upscaling algorithm
// Doubles resolution while smoothing diagonal staircases between colored pixels
function scale2x(grid: readonly string[]): readonly string[] {
  const h = grid.length;
  const w = grid[0].length;
  const result: string[] = [];

  for (let y = 0; y < h; y++) {
    let topRow = '';
    let bottomRow = '';

    for (let x = 0; x < w; x++) {
      const p = grid[y][x];

      if (p === '.') {
        topRow += '..';
        bottomRow += '..';
        continue;
      }

      const b = y > 0 ? grid[y - 1][x] : '.';
      const d = x > 0 ? grid[y][x - 1] : '.';
      const e = x < w - 1 ? grid[y][x + 1] : '.';
      const g = y < h - 1 ? grid[y + 1][x] : '.';

      const p1 = (d === b && d !== g && b !== e && d !== '.') ? d : p;
      const p2 = (b === e && d !== b && g !== e && e !== '.') ? e : p;
      const p3 = (d === g && d !== b && g !== e && d !== '.') ? d : p;
      const p4 = (g === e && d !== g && b !== e && e !== '.') ? e : p;

      topRow += p1 + p2;
      bottomRow += p3 + p4;
    }

    result.push(topRow);
    result.push(bottomRow);
  }

  return result;
}

function processSprite(sprite: {
  readonly grid: readonly string[];
  readonly palette: SpritePalette;
}): SpriteDefinition {
  return { grid: scale2x(addOutline(sprite.grid)), palette: sprite.palette };
}

// Base palette colors — indices 1, 2, 6 are overridden dynamically at render time
const SKIN = '#e8b87e';
const SKIN_SHADOW = '#c48c5a';
const BLACK = '#1a1a2e';
const WHITE = '#e8e8ed';
const BROWN = '#6b4226';
const GRAY_LIGHT = '#9ca3af';
const GRAY_DARK = '#4b5563';
const GOLD = '#f4c430';
const CLOTH_DARK = '#2a1f3d';

// ---------------------------------------------------------------------------
// 32x32 source sprites — professionally designed with 3-tone shading
// 3-tone: 2=highlight (top-left), 1=midtone (center), 6=shadow (bottom-right)
// Outlines are NOT drawn — addOutline() handles that automatically
// ---------------------------------------------------------------------------
const SOURCE_SPRITES: Record<CharacterClassId, SpriteDefinition> = {
  // Hunter — Hooded archer with large curved bow
  // Accent: a = bow wood (#6b4226)
  hunter: {
    grid: [
      '..............22................',
      '.............2221...............',
      '............222211..............',
      '...........22211111.............',
      '..........2221111111............',
      '.........222111111166...........',
      '.........221111111166...........',
      '.........221166666166...........',
      '..........2166334616............',
      '..........1163734731............',
      '..........1163344361............',
      '...........113333311............',
      '............133331..............',
      '...........22111116.............',
      '..........2221111166............',
      '..........2221111166......aaa...',
      '.........22211661166.....aaaa...',
      '.........22116661166....aaaa....',
      '..........2116661166...aaaa.....',
      '..........2116661166..aaaa......',
      '...........116661166.aaaa.......',
      '...........1166111..aaaa........',
      '............116611.aaaa.........',
      '...........21161..aaaa..........',
      '...........21.16..aaa...........',
      '..........221..166..............',
      '..........221..166..............',
      '..........551..556..............',
      '..........551..556..............',
      '.........5551..5566.............',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      'a': BROWN,
    },
  },

  // Rogue — Masked assassin with dual daggers (crouched, widest sprite)
  // Accent: 8 = dagger metal (#9ca3af)
  rogue: {
    grid: [
      '................................',
      '................................',
      '................................',
      '................................',
      '...........666666...............',
      '..........66666666..............',
      '.........6666666666.............',
      '.........6661661666.............',
      '.........6637347366.............',
      '..........66666666..............',
      '...........666666...............',
      '...........221166...............',
      '..........22211166..............',
      '.........2222111166.............',
      '........222211111166............',
      '....88882221166111668888........',
      '....88882211666111168888........',
      '....88882211666111168888........',
      '.....888.21166611116888.........',
      '......88..1166611..88...........',
      '...........116611...............',
      '..........22111166..............',
      '..........21..1166..............',
      '.........221...166..............',
      '.........221...166..............',
      '.........661...166..............',
      '.........551...556..............',
      '.........551...556..............',
      '........5551...5566.............',
      '................................',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '8': GRAY_LIGHT,
    },
  },

  // Summoner — Robed mage with very tall pointed hat + floating orb (tallest)
  // Accent: 9 = hat dark (#2a1f3d), a = orb glow (#c084fc)
  summoner: {
    grid: [
      '..............99................',
      '.............9999...............',
      '............99999...............',
      '...........999999...............',
      '..........99999999..............',
      '..........99211999..............',
      '.........992211199..............',
      '.........999111999..............',
      '........999991119999............',
      '..........1133331...............',
      '..........1333331...............',
      '..........163734731.............',
      '..........163344361.............',
      '...........133331...............',
      '............1331................',
      '...........221116...............',
      '..........22211166..............',
      '.........222111116..............',
      '.........222116616..............',
      '.........222166666..............',
      '..........22116616.....aaaa.....',
      '..........22111166....aaaaa.....',
      '..........22111166....aaaaa.....',
      '.........222111166....aaaaa.....',
      '.........222111166.....aaaa.....',
      '........2222111666..............',
      '........2221111666..............',
      '.........551..556...............',
      '.........551..556...............',
      '................................',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '9': CLOTH_DARK,
      'a': '#c084fc',
    },
  },

  // Merchant — Stocky trader with wide flat-brimmed hat + coin bag (widest body)
  // Accent: a = coin bag brown (#6b4226)
  merchant: {
    grid: [
      '................................',
      '..........222111166.............',
      '.........2221111166.............',
      '........222111111166............',
      '.......66666666666666666........',
      '........6666666666666...........',
      '..........113333116.............',
      '..........133333311.............',
      '..........163734731.............',
      '..........163344361.............',
      '...........133331...............',
      '............1331................',
      '..........22111116..............',
      '.........2221111166.............',
      '........222211111166............',
      '........222211111166............',
      '.......22221111111666...........',
      '.......22221166111666...........',
      '.......22221666611666...........',
      '........2221166111666...........',
      '........222116611166..aaaa......',
      '.........22116611166.aaaaa......',
      '.........2211661116.aaa6aa......',
      '..........2116611...aaaaa.......',
      '..........211.116...aaaa........',
      '..........661.166...............',
      '..........661.166...............',
      '.........5561.5566..............',
      '.........5561.5566..............',
      '........55561.55666.............',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      'a': BROWN,
    },
  },

  // Priest — Holy cleric with bishop mitre headdress + golden staff
  // Accent: 9 = gold staff (#f4c430), a = gold trim/belt (#f4c430)
  priest: {
    grid: [
      '..............aa................',
      '.............a22a...............',
      '............a2221a..............',
      '...........a221116a.............',
      '..........a22111166a...99.......',
      '..........a22111166a..9aa9......',
      '..........a22111166a..9aa9......',
      '..........aa2111166a...99.......',
      '...........163333316...9........',
      '...........163734731...9........',
      '...........163344361...9........',
      '...........113333311...9........',
      '............1133311....9........',
      '...........221111166...9........',
      '..........2221111166...9........',
      '.........22211111166...9........',
      '.........221aaa1166....9........',
      '........2221aaa11666...9........',
      '........222111111166...9........',
      '.......2221111111666...9........',
      '.......22211111116666..9........',
      '......222111111111666..9........',
      '......2221111111116666.9........',
      '.....22211111111111666.9........',
      '.....222111111111116669.........',
      '....2221111111111116669.........',
      '....22211111111111166...........',
      '.....2111111111111166...........',
      '......55..5555..556.............',
      '.......5..........5.............',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '9': GOLD,
      'a': GOLD,
    },
  },

  // Elder Wizard — Classic wizard with pointed hat, long beard + gnarled staff
  // Accent: 9 = white beard/staff (#e8e8ed), a = crystal glow (#c084fc)
  elder_wizard: {
    grid: [
      '..............6..........a.a....',
      '.............666.........aaa....',
      '............6666........aaa.....',
      '...........66616.......a9.......',
      '..........6661a666.....9........',
      '.........66611116666...9........',
      '........6662111116666..9........',
      '.......666621111166666.9........',
      '........6662221116666..9........',
      '..........163333316...9.........',
      '..........163734731...9.........',
      '..........163344361...9.........',
      '..........113993311...9.........',
      '..........19999999....9.........',
      '.........2199999991...9.........',
      '.........2219999116...9.........',
      '........22219999116...9.........',
      '........22199991166...9.........',
      '.......222199911166...9.........',
      '.......222111111166...9.........',
      '......2221111111166...9.........',
      '......222111111116666.9.........',
      '.....2221111111111666...........',
      '.....222111111111166............',
      '....2221111111111166............',
      '....22211111.111116.............',
      '.....2211111.111116.............',
      '......2211....1116..............',
      '.......55......55...............',
      '.......55......55...............',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '9': WHITE,
      'a': '#c084fc',
    },
  },

  // Guardian — Heavy knight with full helmet + massive kite shield
  // Accent: 8 = dark helmet metal (#4b5563), a = light shield metal (#9ca3af)
  guardian: {
    grid: [
      '................................',
      '.........888888.................',
      '........8888a8888...............',
      '.......888aaaa888...............',
      '.......88a3333a88...............',
      '.......88a73437a88..............',
      '.......8888aa8888...............',
      '........88888888................',
      '......22211111166aaaaaaa........',
      '.....2221111111661aaaaaaaa......',
      '.....22211111116666aaaaaaa......',
      '....2221116611661a222aaaaa......',
      '....2221116611661a2222aaaa......',
      '.....221116611661aa22266aa......',
      '.....221116611661aa22666aa......',
      '.....22111661166aa2222aaaa......',
      '......221166116aa222aaaaa.......',
      '......2211661166aaaaaaaa........',
      '.....222111111661aaaaaaaa.......',
      '.....22111111166116aaaaaaa......',
      '....2221111111661166aaaaaa......',
      '....22111111111166..............',
      '.....22111..11166...............',
      '.....22166..61166...............',
      '....22166....61166..............',
      '....1166......6611..............',
      '.....66........66...............',
      '....555........555..............',
      '....5555......5555..............',
      '................................',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '8': GRAY_DARK,
      'a': GRAY_LIGHT,
    },
  },

  // Warrior — Swordsman with raised sword above head + helmet
  // Accent: 8 = sword/helmet metal (#9ca3af), a = gold hilt (#f4c430)
  warrior: {
    grid: [
      '...................8............',
      '...................8............',
      '...................8............',
      '...................88...........',
      '..................888...........',
      '..................a88a..........',
      '.................aaaa...........',
      '..........888888821.............',
      '.........88888888211............',
      '.........888aaaa88221...........',
      '........888a33a888216...........',
      '........88a37437a88116..........',
      '........888aaaa888116...........',
      '.........888888886..............',
      '.......22211111111166...........',
      '......2221111111111166..........',
      '......22211111661116............',
      '.......2211116611166............',
      '.......2211116611166............',
      '........22111161116.............',
      '........2211111116..............',
      '........22111111166.............',
      '.......22111..1166..............',
      '.......22166..6116..............',
      '......22166....6166.............',
      '......2166......616.............',
      '.......66........66.............',
      '.......55........55.............',
      '......555........555............',
      '................................',
      '................................',
      '................................',
    ],
    palette: {
      '3': SKIN,
      '4': SKIN_SHADOW,
      '5': BROWN,
      '7': BLACK,
      '8': GRAY_LIGHT,
      'a': GOLD,
    },
  },
};

// Export 64x64 upscaled sprites via Scale2x
// Pipeline: source 32x32 → addOutline → scale2x → export 64x64
export const SPRITE_DATA: Record<CharacterClassId, SpriteDefinition> =
  Object.fromEntries(
    Object.entries(SOURCE_SPRITES).map(([key, sprite]) => [
      key,
      processSprite(sprite),
    ]),
  ) as Record<CharacterClassId, SpriteDefinition>;
